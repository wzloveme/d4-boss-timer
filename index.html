<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Diablo 4 World Boss Timer</title>

<style>
  body {
    margin: 0;
    padding: 16px;
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    display: flex;
    justify-content: center;
  }

  .app {
    width: 100%;
    max-width: 420px;
    text-align: center;
  }

  h1 {
    font-size: 1.4rem;
    margin-bottom: 8px;
  }

  .countdown {
    font-size: 2.6rem;
    margin: 16px 0;
  }

  .red {
    color: #ff4d4d;
  }

  .time {
    font-size: 0.9rem;
    color: #aaa;
  }

  label {
    display: block;
    text-align: left;
    margin-top: 14px;
    font-size: 0.9rem;
    color: #ccc;
  }

  input, button {
    width: 100%;
    padding: 14px;
    margin-top: 8px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    box-sizing: border-box;
  }

  input {
    background: #222;
    color: #fff;
  }

  button {
    background: #2d7cff;
    color: #fff;
    cursor: pointer;
  }

  button.secondary {
    background: #444;
  }

  .status {
    margin-top: 10px;
    font-size: 0.85rem;
    color: #7cff7c;
  }

  .status.off {
    color: #ffb84d;
  }
</style>
</head>

<body>
<div class="app">
  <h1>Diablo 4 World Boss</h1>

  <div id="countdown" class="countdown">--:--</div>
  <div id="nextTime" class="time"></div>

  <label>æå‰æé†’ï¼ˆåˆ†é’Ÿï¼‰</label>
  <input type="number" id="notifyBefore" min="1" value="10" />

  <button onclick="enableNotifications()">ğŸ”” å¼€å¯æé†’</button>
  <div id="notifyStatus" class="status off">æé†’æœªå¼€å¯</div>

  <button class="secondary" onclick="markBossNow()">ğŸ”´ Boss åˆšåˆ·</button>

  <label>æ‰‹åŠ¨è¾“å…¥ä¸Šæ¬¡ Boss æ—¶é—´</label>
  <input type="datetime-local" id="manualTime" />
  <button class="secondary" onclick="setManualTime()">ä¿å­˜æ—¶é—´</button>
</div>

<script>
const BOSS_INTERVAL = 105 * 60 * 1000;
let lastBossUTC = null;
let notifyTimeout = null;
let notificationsEnabled = false;

function nowUTC() {
  return Date.now();
}

function saveLastBoss(ts) {
  localStorage.setItem("lastBossUTC", ts.toString());
}

function loadLastBoss() {
  const v = localStorage.getItem("lastBossUTC");
  return v ? parseInt(v, 10) : null;
}

function saveNotifyEnabled(v) {
  localStorage.setItem("notifyEnabled", v ? "1" : "0");
}

function loadNotifyEnabled() {
  return localStorage.getItem("notifyEnabled") === "1";
}

function updateNotifyStatus() {
  const el = document.getElementById("notifyStatus");
  if (notificationsEnabled) {
    el.textContent = "æé†’å·²å¼€å¯";
    el.classList.remove("off");
  } else {
    el.textContent = "æé†’æœªå¼€å¯";
    el.classList.add("off");
  }
}

function enableNotifications() {
  Notification.requestPermission().then(p => {
    if (p === "granted") {
      notificationsEnabled = true;
      saveNotifyEnabled(true);
      updateNotifyStatus();
      if (lastBossUTC) {
        scheduleNotification(lastBossUTC + BOSS_INTERVAL);
      }
    } else {
      alert("éœ€è¦å…è®¸é€šçŸ¥æƒé™æ‰èƒ½æé†’");
    }
  });
}

function scheduleNotification(nextBossUTC) {
  clearTimeout(notifyTimeout);
  if (!notificationsEnabled || Notification.permission !== "granted") return;

  const mins = parseInt(document.getElementById("notifyBefore").value, 10);
  const notifyTime = nextBossUTC - mins * 60 * 1000;
  const delay = notifyTime - nowUTC();

  if (delay > 0) {
    notifyTimeout = setTimeout(() => {
      new Notification("World Boss å³å°†åˆ·æ–°", {
        body: `è¿˜æœ‰ ${mins} åˆ†é’Ÿåˆ·æ–°`
      });
    }, delay);
  }
}

function update() {
  if (!lastBossUTC) return;

  const nextBossUTC = lastBossUTC + BOSS_INTERVAL;
  let diff = nextBossUTC - nowUTC();

  if (diff <= 0) {
    lastBossUTC = nextBossUTC;
    saveLastBoss(lastBossUTC);
    scheduleNotification(lastBossUTC + BOSS_INTERVAL);
    return;
  }

  const mins = Math.floor(diff / 60000);
  const secs = Math.floor((diff % 60000) / 1000);

  const cd = document.getElementById("countdown");
  cd.textContent = `${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
  cd.classList.toggle("red", diff < 10 * 60 * 1000);

  document.getElementById("nextTime").textContent =
    "Next Boss: " + new Date(nextBossUTC).toLocaleString();
}

function markBossNow() {
  lastBossUTC = nowUTC();
  saveLastBoss(lastBossUTC);
  scheduleNotification(lastBossUTC + BOSS_INTERVAL);
}

function setManualTime() {
  const v = document.getElementById("manualTime").value;
  if (!v) return;
  const ts = new Date(v).getTime();
  lastBossUTC = ts;
  saveLastBoss(ts);
  scheduleNotification(ts + BOSS_INTERVAL);
}

(function init() {
  lastBossUTC = loadLastBoss();
  notificationsEnabled = loadNotifyEnabled();
  updateNotifyStatus();
  setInterval(update, 1000);
})();
</script>
</body>
</html>
