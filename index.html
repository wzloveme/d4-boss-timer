<body>
  <h2>暗黑 4 世界 Boss</h2>

  <button onclick="markBossNow()">Boss 刚刷</button>
  <button onclick="enableNotify()">开启 Boss 提前提醒</button>

  <p id="next"></p>
  <p id="countdown" style="font-size:20px;"></p>

  <script>
    let lastBoss = new Date("2025-12-30T10:45:00"); // 初始锚点
    const notifyBeforeMinutes = 1; // 提前提醒分钟

    function updateTimer() {
      const interval = 105 * 60 * 1000;
      let now = new Date();

      while (lastBoss.getTime() + interval <= now.getTime()) {
        lastBoss = new Date(lastBoss.getTime() + interval);
      }

      let nextBoss = new Date(lastBoss.getTime() + interval);
      let diff = nextBoss - now;

      let h = Math.floor(diff / 3600000);
      let m = Math.floor((diff % 3600000) / 60000);
      let s = Math.floor((diff % 60000) / 1000);

      document.getElementById("next").innerText =
        "下次 Boss 时间：" + nextBoss.toLocaleString();

      document.getElementById("countdown").innerText =
        `剩余：${h}小时 ${m}分 ${s}秒`;
    }

    setInterval(updateTimer, 1000);
    updateTimer();

    function markBossNow() {
      lastBoss = new Date();
      scheduleNotify();
      alert("已记录 Boss 刚刚刷新");
    }

    function enableNotify() {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          scheduleNotify();
          alert("世界 Boss 提前提醒已开启");
        } else {
          alert("未允许通知");
        }
      });
    }

    function scheduleNotify() {
      navigator.serviceWorker.ready.then(reg => {
        reg.active.postMessage({
          type: "schedule",
          lastBoss: lastBoss.getTime(),
          before: notifyBeforeMinutes
        });
      });
    }

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
