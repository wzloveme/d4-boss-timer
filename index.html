<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Diablo 4 World Boss Timer</title>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #111;
    color: #fff;
    margin: 0;
    padding: 16px;
    display: flex;
    justify-content: center;
  }

  .app {
    width: 100%;
    max-width: 420px;
    text-align: center;
  }

  h1 {
    margin-bottom: 8px;
    font-size: 1.4rem;
  }

  .countdown {
    font-size: 2.4rem;
    margin: 16px 0;
  }

  .red {
    color: #ff4d4d;
  }

  .time {
    font-size: 0.9rem;
    color: #aaa;
  }

  button, input {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
  }

  button {
    background: #2d7cff;
    color: white;
  }

  button.secondary {
    background: #444;
  }

  input {
    background: #222;
    color: white;
  }

  label {
    font-size: 0.9rem;
    margin-top: 12px;
    display: block;
    text-align: left;
    color: #ccc;
  }
</style>
</head>

<body>
<div class="app">
  <h1>Diablo 4 World Boss</h1>

  <div id="countdown" class="countdown">--:--</div>
  <div id="nextTime" class="time"></div>

  <label>æå‰æé†’ï¼ˆåˆ†é’Ÿï¼‰</label>
  <input type="number" id="notifyBefore" min="1" value="10" />

  <button onclick="markBossNow()">ğŸ”´ Boss åˆšåˆ·</button>

  <label>æ‰‹åŠ¨è¾“å…¥ä¸Šæ¬¡ Boss æ—¶é—´</label>
  <input type="datetime-local" id="manualTime" />
  <button class="secondary" onclick="setManualTime()">ä¿å­˜æ—¶é—´</button>
</div>

<script>
const BOSS_INTERVAL = 105 * 60 * 1000; // å›ºå®š 105 åˆ†é’Ÿ
let lastBossUTC = null;
let notifyTimeout = null;

function nowUTC() {
  return Date.now();
}

function saveLastBoss(ts) {
  localStorage.setItem("lastBossUTC", ts.toString());
}

function loadLastBoss() {
  const v = localStorage.getItem("lastBossUTC");
  return v ? parseInt(v, 10) : null;
}

function requestNotifyPermission() {
  if (Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function scheduleNotification(nextBossUTC) {
  clearTimeout(notifyTimeout);

  if (Notification.permission !== "granted") return;

  const mins = parseInt(document.getElementById("notifyBefore").value, 10);
  const notifyTime = nextBossUTC - mins * 60 * 1000;
  const delay = notifyTime - nowUTC();

  if (delay > 0) {
    notifyTimeout = setTimeout(() => {
      new Notification("World Boss Incoming", {
        body: `Boss will spawn in ${mins} minutes`
      });
    }, delay);
  }
}

function update() {
  if (!lastBossUTC) return;

  const nextBossUTC = lastBossUTC + BOSS_INTERVAL;
  let diff = nextBossUTC - nowUTC();

  if (diff <= 0) {
    lastBossUTC = nextBossUTC;
    saveLastBoss(lastBossUTC);
    scheduleNotification(lastBossUTC + BOSS_INTERVAL);
    return;
  }

  const mins = Math.floor(diff / 60000);
  const secs = Math.floor((diff % 60000) / 1000);
  const el = document.getElementById("countdown");

  el.textContent =
    `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;

  el.classList.toggle("red", diff < 10 * 60 * 1000);

  document.getElementById("nextTime").textContent =
    "Next Boss: " + new Date(nextBossUTC).toLocaleString();
}

function markBossNow() {
  lastBossUTC = nowUTC();
  saveLastBoss(lastBossUTC);
  scheduleNotification(lastBossUTC + BOSS_INTERVAL);
}

function setManualTime() {
  const input = document.getElementById("manualTime").value;
  if (!input) return;

  // å…³é”®ä¿®å¤ç‚¹ï¼šåªå– timestamp
  const ts = new Date(input).getTime();
  lastBossUTC = ts;
  saveLastBoss(ts);
  scheduleNotification(ts + BOSS_INTERVAL);
}

(function init() {
  requestNotifyPermission();
  lastBossUTC = loadLastBoss();
  setInterval(update, 1000);
})();
</script>
</body>
</html>
